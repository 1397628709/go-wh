# SuperBizAgent 项目启动完整流程

## 一、环境准备

### 1.1 系统要求

- **操作系统**: Windows 10/11, macOS, Linux
- **Go 版本**: Go 1.24.0 或更高
- **内存**: 建议 8GB 以上
- **磁盘空间**: 至少 10GB 可用空间

### 1.2 必需软件安装

#### 1.2.1 Go 语言环境

**Windows**:
```powershell
# 下载并安装 Go 1.24.0
# 访问: https://go.dev/dl/
# 下载 go1.24.0.windows-amd64.msi 并安装

# 验证安装
go version
# 输出: go version go1.24.0 windows/amd64
```

**macOS**:
```bash
# 使用 Homebrew 安装
brew install go@1.24

# 验证安装
go version
```

**Linux**:
```bash
# 下载并解压
wget https://go.dev/dl/go1.24.0.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.24.0.linux-amd64.tar.gz

# 配置环境变量
echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
source ~/.bashrc

# 验证安装
go version
```

#### 1.2.2 Milvus 向量数据库

**使用 Docker Compose 安装 (推荐)**:

```bash
# 1. 安装 Docker 和 Docker Compose
# Windows: 下载 Docker Desktop
# macOS: brew install --cask docker
# Linux: 参考 Docker 官方文档

# 2. 下载 Milvus Docker Compose 配置
wget https://github.com/milvus-io/milvus/releases/download/v2.4.2/milvus-standalone-docker-compose.yml -O docker-compose.yml

# 3. 启动 Milvus
docker-compose up -d

# 4. 验证 Milvus 是否启动成功
docker-compose ps
# 应该看到 milvus-standalone 和 milvus-minio 等容器运行中

# 5. 检查 Milvus 端口
# Milvus 默认监听 19530 端口
netstat -an | grep 19530  # Linux/macOS
netstat -an | findstr 19530  # Windows
```

**Milvus 配置说明**:
- 默认端口: `19530`
- 数据存储: `./volumes/milvus` (本地目录)
- 管理界面: Attu (可选安装)

#### 1.2.3 MySQL 数据库

**Windows**:
```powershell
# 下载 MySQL 8.0+
# 访问: https://dev.mysql.com/downloads/mysql/
# 安装 MySQL Community Server

# 启动 MySQL 服务
net start MySQL80

# 创建数据库
mysql -u root -p
CREATE DATABASE test CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

**macOS**:
```bash
# 使用 Homebrew 安装
brew install mysql

# 启动 MySQL
brew services start mysql

# 创建数据库
mysql -u root
CREATE DATABASE test CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

**Linux**:
```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install mysql-server

# 启动 MySQL
sudo systemctl start mysql

# 创建数据库
sudo mysql
CREATE DATABASE test CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

#### 1.2.4 Prometheus (可选,用于告警监控)

**使用 Docker 安装**:
```bash
# 拉取 Prometheus 镜像
docker pull prom/prometheus

# 创建配置文件 prometheus.yml
cat > prometheus.yml <<EOF
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
EOF

# 启动 Prometheus
docker run -d \
  --name prometheus \
  -p 9090:9090 \
  -v $(pwd)/prometheus.yml:/etc/prometheus/prometheus.yml \
  prom/prometheus
```

---

## 二、项目配置

### 2.1 克隆项目

```bash
# 克隆项目到本地
git clone <项目地址>
cd SuperBizAgent

# 或者如果已有项目,直接进入目录
cd d:\2_GoGithub\SuperBizAgent
```

### 2.2 安装依赖

```bash
# 下载 Go 模块依赖
go mod download

# 验证依赖
go mod verify

# 如果遇到网络问题,配置 Go 代理
go env -w GOPROXY=https://goproxy.cn,direct
```

### 2.3 配置文件设置

#### 2.3.1 创建配置文件

项目使用 GoFrame 的配置管理,配置文件位于 `hack/config.yaml`:

```yaml
# hack/config.yaml

# 文件存储目录
file_dir: "./docs/"

# 数据库配置
database:
  default:
    link: "mysql:root:12345678@tcp(127.0.0.1:3306)/test"
    debug: true

# Milvus 配置
milvus:
  address: "localhost:19530"
  database: "agent"
  collection: "biz"

# LLM 配置
llm:
  openai:
    api_key: "${OPENAI_API_KEY}"  # 从环境变量读取
    base_url: "https://api.openai.com/v1"
    model: "gpt-4"

# Embedding 配置
embedding:
  ark:
    api_key: "${ARK_API_KEY}"  # 从环境变量读取
    endpoint: "https://ark.cn-beijing.volces.com/api/v3"

# 服务器配置
server:
  port: 6872
  log_path: "./logs"
```

#### 2.3.2 环境变量配置

**Windows (PowerShell)**:
```powershell
# 设置 OpenAI API Key
$env:OPENAI_API_KEY = "sk-your-openai-api-key"

# 设置 Ark Embedding API Key
$env:ARK_API_KEY = "your-ark-api-key"

# 永久设置 (可选)
[System.Environment]::SetEnvironmentVariable("OPENAI_API_KEY", "sk-your-openai-api-key", "User")
[System.Environment]::SetEnvironmentVariable("ARK_API_KEY", "your-ark-api-key", "User")
```

**macOS/Linux (Bash)**:
```bash
# 设置环境变量
export OPENAI_API_KEY="sk-your-openai-api-key"
export ARK_API_KEY="your-ark-api-key"

# 永久设置 (添加到 ~/.bashrc 或 ~/.zshrc)
echo 'export OPENAI_API_KEY="sk-your-openai-api-key"' >> ~/.bashrc
echo 'export ARK_API_KEY="your-ark-api-key"' >> ~/.bashrc
source ~/.bashrc
```

#### 2.3.3 创建必要目录

```bash
# 创建文档存储目录
mkdir -p docs

# 创建日志目录
mkdir -p logs

# 验证目录结构
ls -la
```

---

## 三、数据库初始化

### 3.1 MySQL 数据库初始化

项目使用 GORM,数据库表会自动创建。如果需要手动初始化:

```sql
-- 连接到 MySQL
mysql -u root -p

-- 使用数据库
USE test;

-- 验证数据库
SHOW DATABASES;
```

### 3.2 Milvus 初始化

Milvus 的 Database 和 Collection 会在首次运行时自动创建,无需手动初始化。

**自动创建逻辑** (参考 `utility/client/client.go`):
1. 连接到 Milvus 的 `default` 数据库
2. 检查 `agent` 数据库是否存在,不存在则创建
3. 切换到 `agent` 数据库
4. 检查 `biz` Collection 是否存在,不存在则创建
5. 为 Collection 创建索引 (id、content、vector)

**验证 Milvus**:
```bash
# 使用 Milvus CLI (可选)
pip install pymilvus

# Python 验证脚本
python3 << EOF
from pymilvus import connections, utility

# 连接 Milvus
connections.connect(host='localhost', port='19530')

# 列出所有数据库
print("Databases:", utility.list_database())

# 列出所有 Collection
print("Collections:", utility.list_collections())
EOF
```

---

## 四、启动项目

### 4.1 启动后端服务

#### 方式一: 直接运行 (开发环境)

```bash
# 进入项目根目录
cd d:\2_GoGithub\SuperBizAgent

# 运行项目
go run main.go

# 输出示例:
# 2026-01-20 16:30:00.000 [INFO] Server started at :6872
# 2026-01-20 16:30:00.001 [INFO] Milvus connected successfully
# 2026-01-20 16:30:00.002 [INFO] Database initialized
```

#### 方式二: 编译后运行 (生产环境)

**Windows**:
```powershell
# 编译
go build -o SuperBizAgent.exe main.go

# 运行
.\SuperBizAgent.exe
```

**macOS/Linux**:
```bash
# 编译
go build -o SuperBizAgent main.go

# 赋予执行权限
chmod +x SuperBizAgent

# 运行
./SuperBizAgent
```

#### 方式三: 使用 Docker (推荐生产环境)

```bash
# 构建 Docker 镜像
docker build -t superbizagent:latest -f manifest/docker/Dockerfile .

# 运行容器
docker run -d \
  --name superbizagent \
  -p 6872:6872 \
  -e OPENAI_API_KEY="sk-your-key" \
  -e ARK_API_KEY="your-ark-key" \
  -v $(pwd)/docs:/app/docs \
  -v $(pwd)/logs:/app/logs \
  superbizagent:latest

# 查看日志
docker logs -f superbizagent
```

### 4.2 验证后端服务

```bash
# 检查服务是否启动
curl http://localhost:6872/api/health
# 或使用浏览器访问

# 检查端口监听
netstat -an | grep 6872  # Linux/macOS
netstat -an | findstr 6872  # Windows
```

### 4.3 启动前端服务

```bash
# 进入前端目录
cd SuperBizAgentFrontend

# 如果使用 Node.js 服务器
npm install
npm start

# 或者直接用浏览器打开 index.html
# Windows: start index.html
# macOS: open index.html
# Linux: xdg-open index.html
```

---

## 五、功能验证

### 5.1 测试普通对话

```bash
# 使用 curl 测试
curl -X POST http://localhost:6872/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "id": "user123",
    "question": "你好,请介绍一下自己"
  }'

# 预期响应:
# {
#   "code": 0,
#   "message": "success",
#   "data": {
#     "answer": "你好!我是对话小助手..."
#   }
# }
```

### 5.2 测试流式对话

```bash
# 使用 curl 测试 SSE
curl -N -X POST http://localhost:6872/api/chat_stream \
  -H "Content-Type: application/json" \
  -d '{
    "id": "user123",
    "question": "请解释一下什么是 RAG"
  }'

# 预期响应 (流式):
# data: {"type":"message","content":"RAG"}
# data: {"type":"message","content":" 是"}
# data: {"type":"message","content":" 检索"}
# ...
# data: {"type":"done","content":"Stream completed"}
```

### 5.3 测试文件上传

```bash
# 创建测试文件
echo "这是一个测试文档" > test.txt

# 上传文件
curl -X POST http://localhost:6872/api/upload \
  -F "file=@test.txt"

# 预期响应:
# {
#   "code": 0,
#   "message": "success",
#   "data": {
#     "fileName": "test.txt",
#     "filePath": "./docs/test.txt",
#     "fileSize": 24
#   }
# }
```

### 5.4 测试 AI 运维

```bash
# 测试 AI 运维功能
curl -X POST http://localhost:6872/api/ai_ops \
  -H "Content-Type: application/json"

# 预期响应:
# {
#   "code": 0,
#   "message": "success",
#   "data": {
#     "result": "# 告警分析报告\n...",
#     "detail": ["步骤1输出", "步骤2输出", ...]
#   }
# }
```

---

## 六、常见问题排查

### 6.1 Milvus 连接失败

**问题**: `failed to connect to Milvus`

**排查步骤**:
```bash
# 1. 检查 Milvus 是否启动
docker ps | grep milvus

# 2. 检查端口是否监听
netstat -an | grep 19530

# 3. 检查 Milvus 日志
docker logs milvus-standalone

# 4. 重启 Milvus
docker-compose restart
```

### 6.2 MySQL 连接失败

**问题**: `Error 1045: Access denied for user 'root'@'localhost'`

**解决方案**:
```bash
# 1. 重置 MySQL 密码
mysql -u root
ALTER USER 'root'@'localhost' IDENTIFIED BY '12345678';
FLUSH PRIVILEGES;

# 2. 检查配置文件中的密码是否正确
cat hack/config.yaml | grep link

# 3. 测试连接
mysql -u root -p12345678 -e "SHOW DATABASES;"
```

### 6.3 OpenAI API 调用失败

**问题**: `401 Unauthorized` 或 `429 Rate Limit`

**排查步骤**:
```bash
# 1. 检查环境变量
echo $OPENAI_API_KEY  # Linux/macOS
echo $env:OPENAI_API_KEY  # Windows

# 2. 验证 API Key
curl https://api.openai.com/v1/models \
  -H "Authorization: Bearer $OPENAI_API_KEY"

# 3. 检查配额和余额
# 访问: https://platform.openai.com/account/usage
```

### 6.4 端口被占用

**问题**: `bind: address already in use`

**解决方案**:
```bash
# Windows
netstat -ano | findstr 6872
taskkill /PID <进程ID> /F

# Linux/macOS
lsof -i :6872
kill -9 <进程ID>

# 或修改配置文件中的端口
# hack/config.yaml -> server.port: 6873
```

### 6.5 Go 依赖下载失败

**问题**: `timeout` 或 `connection refused`

**解决方案**:
```bash
# 配置 Go 代理
go env -w GOPROXY=https://goproxy.cn,direct

# 或使用其他代理
go env -w GOPROXY=https://goproxy.io,direct

# 清理缓存重新下载
go clean -modcache
go mod download
```

---

## 七、生产环境部署

### 7.1 使用 Docker Compose 部署

**创建 docker-compose.yml**:
```yaml
version: '3.8'

services:
  superbizagent:
    build:
      context: .
      dockerfile: manifest/docker/Dockerfile
    ports:
      - "6872:6872"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ARK_API_KEY=${ARK_API_KEY}
    volumes:
      - ./docs:/app/docs
      - ./logs:/app/logs
    depends_on:
      - milvus
      - mysql
    restart: unless-stopped

  milvus:
    image: milvusdb/milvus:v2.4.2
    ports:
      - "19530:19530"
    volumes:
      - ./volumes/milvus:/var/lib/milvus
    restart: unless-stopped

  mysql:
    image: mysql:8.0
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=12345678
      - MYSQL_DATABASE=test
    volumes:
      - ./volumes/mysql:/var/lib/mysql
    restart: unless-stopped
```

**启动所有服务**:
```bash
# 启动
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止
docker-compose down
```

### 7.2 性能优化配置

**Go 程序优化**:
```bash
# 编译时优化
go build -ldflags="-s -w" -o SuperBizAgent main.go

# 设置 GOMAXPROCS (根据 CPU 核心数)
export GOMAXPROCS=4
```

**Milvus 优化**:
```yaml
# milvus.yaml
dataCoord:
  segment:
    maxSize: 1024  # MB
queryNode:
  cacheSize: 4096  # MB
```

### 7.3 监控和日志

**日志配置**:
```yaml
# hack/config.yaml
logger:
  level: "info"
  stdout: true
  file: "./logs/app.log"
  rotateSize: 100  # MB
  rotateCount: 10
```

**Prometheus 监控**:
```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'superbizagent'
    static_configs:
      - targets: ['localhost:6872']
```

---

## 八、启动检查清单

### 8.1 启动前检查

- [ ] Go 1.24.0+ 已安装
- [ ] Milvus 已启动 (端口 19530)
- [ ] MySQL 已启动 (端口 3306)
- [ ] 环境变量已配置 (OPENAI_API_KEY, ARK_API_KEY)
- [ ] 配置文件已创建 (hack/config.yaml)
- [ ] 必要目录已创建 (docs, logs)
- [ ] Go 依赖已下载 (go mod download)

### 8.2 启动后验证

- [ ] 后端服务启动成功 (端口 6872)
- [ ] Milvus 连接成功
- [ ] MySQL 连接成功
- [ ] 普通对话接口正常
- [ ] 流式对话接口正常
- [ ] 文件上传接口正常
- [ ] AI 运维接口正常

### 8.3 功能测试

- [ ] 上传测试文档
- [ ] 测试知识库检索
- [ ] 测试对话历史保存
- [ ] 测试工具调用 (Prometheus、MySQL)
- [ ] 测试并发请求

---

## 九、快速启动脚本

### 9.1 Windows 启动脚本

**start.ps1**:
```powershell
# 检查环境
Write-Host "检查环境..." -ForegroundColor Green

# 检查 Go
if (!(Get-Command go -ErrorAction SilentlyContinue)) {
    Write-Host "错误: Go 未安装" -ForegroundColor Red
    exit 1
}

# 检查 Docker
if (!(Get-Command docker -ErrorAction SilentlyContinue)) {
    Write-Host "警告: Docker 未安装,Milvus 需要手动启动" -ForegroundColor Yellow
}

# 启动 Milvus
Write-Host "启动 Milvus..." -ForegroundColor Green
docker-compose up -d

# 等待 Milvus 启动
Start-Sleep -Seconds 5

# 下载依赖
Write-Host "下载依赖..." -ForegroundColor Green
go mod download

# 启动服务
Write-Host "启动服务..." -ForegroundColor Green
go run main.go
```

### 9.2 Linux/macOS 启动脚本

**start.sh**:
```bash
#!/bin/bash

# 颜色定义
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}检查环境...${NC}"

# 检查 Go
if ! command -v go &> /dev/null; then
    echo -e "${RED}错误: Go 未安装${NC}"
    exit 1
fi

# 检查 Docker
if ! command -v docker &> /dev/null; then
    echo -e "${YELLOW}警告: Docker 未安装,Milvus 需要手动启动${NC}"
fi

# 启动 Milvus
echo -e "${GREEN}启动 Milvus...${NC}"
docker-compose up -d

# 等待 Milvus 启动
sleep 5

# 下载依赖
echo -e "${GREEN}下载依赖...${NC}"
go mod download

# 启动服务
echo -e "${GREEN}启动服务...${NC}"
go run main.go
```

**使用方法**:
```bash
# 赋予执行权限
chmod +x start.sh

# 运行
./start.sh
```

---

## 十、总结

### 启动流程总览

```
1. 环境准备
   ├─ 安装 Go 1.24.0+
   ├─ 安装 Milvus (Docker)
   ├─ 安装 MySQL
   └─ 安装 Prometheus (可选)

2. 项目配置
   ├─ 克隆项目
   ├─ 下载依赖 (go mod download)
   ├─ 配置文件 (hack/config.yaml)
   └─ 环境变量 (API Keys)

3. 数据库初始化
   ├─ MySQL 创建数据库
   └─ Milvus 自动初始化

4. 启动服务
   ├─ 启动 Milvus (docker-compose up -d)
   ├─ 启动后端 (go run main.go)
   └─ 启动前端 (打开 index.html)

5. 功能验证
   ├─ 测试对话接口
   ├─ 测试文件上传
   └─ 测试 AI 运维
```

### 关键端口

- **后端服务**: 6872
- **Milvus**: 19530
- **MySQL**: 3306
- **Prometheus**: 9090 (可选)

### 重要文件

- **配置文件**: `hack/config.yaml`
- **主程序**: `main.go`
- **前端页面**: `SuperBizAgentFrontend/index.html`
- **Docker 配置**: `manifest/docker/docker-compose.yml`

### 下一步

项目启动成功后,可以:
1. 上传运维文档到知识库
2. 配置 Prometheus 告警规则
3. 测试完整的 AI 运维流程
4. 根据实际需求调整配置
